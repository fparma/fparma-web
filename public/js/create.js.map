{"version":3,"sources":["create.js"],"names":["$","capitalize","str","charAt","toUpperCase","slice","getSideContainer","side","removeSide","sideContainer","removeClass","children","empty","addClass","toggleShowSide","hasClass","toggleClass","createNewGroup","amountUnits","skipTransition","grpContainer","GRP_TEMPLATE","clone","unitRoot","l","UNITS_IN_NEW_GRP","i","append","UNIT_TEMPLATE","title","prev","html","addGroupClickHandlers","appendTo","find","hide","transition","updateUnitsInGroup","removeGroup","groupEl","rootEl","closest","animation","allowRepeats","onComplete","remove","length","amount","MAX_UNITS_IN_GRP","popup","exclusive","position","on","click","parent","units","this","e","unit","last","duration","remaining","getEventData","evt","name","val","type","toLowerCase","authors","description","image_url","d","dateInput","getUTCDate","date","toISOString","grps","groups","SLOT_SIDES","each","desc","push","submitEvent","btnSubmit","ajax","url","contentType","data","JSON","stringify","success","response","ok","window","location","replace","origin","cntr","isArray","error","err","fadeIn","formCreate","tab","form","fields","author","identifier","optional","rules","prompt","onSuccess","preventDefault","selector","message","SLOTS_INP","MIN","MAX","btnManual","btnSqm","slotsContainer","$this","trim","fadeOut","updateTime","format","formatDateStr","pickDate","pickadate","t","pickTime","pickatime","obj","setHours","hour","setMinutes","mins","moment","utc","selectYears","firstDay","min","add","toDate","max","formatLabel","change","getDisplayDate","getUnitsAmount","filter","v","map","reduce","a","b","missingMsg","attr","forEach","substr","lastIndexOf","sqmErrorContainer","printSqmError","msg","xhr2","FormData","ajaxSettings","xhr","fileForm","sqmFileInput","sqmUploadBtn","resetFileInput","wrap","get","reset","unwrap","file","files","size","submit","handleParsedSqmGroups","reply","sides","grp","indexOf","grpCntr","grpInp","inp","splice","formData","cache","processData","always","jQuery"],"mappings":"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","file":"create.js","sourcesContent":["(function ($) {\r\n  var formCreate = $('#create')\r\n  formCreate.find('.js-tab').tab()\r\n\r\n  formCreate.form({\r\n    fields: {\r\n      author: {\r\n        identifier: 'author',\r\n        optional: true,\r\n        rules: [{\r\n          type: 'maxLength[24]',\r\n          prompt: 'Authors cannot contain more than 24 characters'\r\n        }]\r\n      },\r\n      name: {\r\n        identifier: 'name',\r\n        rules: [{\r\n          type: 'empty',\r\n          prompt: 'Event name cannot be empty'\r\n        }, {\r\n          type: 'maxLength[48]',\r\n          prompt: 'Event name cannot contain more than 48 characters'\r\n        }, {\r\n          type: 'minLength[4]',\r\n          prompt: 'Event name must contain more than 3 characters'\r\n        }]\r\n      },\r\n      description: {\r\n        identifier: 'description',\r\n        rules: [{\r\n          type: 'empty',\r\n          prompt: 'Description cannot be empty'\r\n        }, {\r\n          type: 'maxLength[4096]',\r\n          prompt: 'Description cannot contain more than 4096 characters'\r\n        }, {\r\n          type: 'minLength[25]',\r\n          prompt: 'Description must contain more than 24 characters'\r\n        }]\r\n      }\r\n    },\r\n    onSuccess: function (e) {\r\n      e.preventDefault()\r\n      submitEvent()\r\n    },\r\n    selector: {\r\n      message: '#js-create-errors'\r\n    }\r\n  })\r\n\r\n  var SLOTS_INP = {\r\n    MIN: 2,\r\n    MAX: 24\r\n  }\r\n  var UNITS_IN_NEW_GRP = 8\r\n  var MAX_UNITS_IN_GRP = 20\r\n  var GRP_TEMPLATE = $($('#js-grp-template').html())\r\n  var UNIT_TEMPLATE = $($('#js-unit-template').html())\r\n  var SLOT_SIDES = ['blufor', 'opfor', 'greenfor', 'civilian']\r\n\r\n  var btnManual = $('#js-slots-btn-manual')\r\n  var btnSqm = $('#js-slots-btn-sqm')\r\n  var btnSubmit = $('#submit-btn')\r\n  var slotsContainer = $('#slots')\r\n  slotsContainer.hide().removeClass('invis')\r\n\r\n  function capitalize (str) {\r\n    return str.charAt(0).toUpperCase() + str.slice(1)\r\n  }\r\n\r\n  function getSideContainer (side) {\r\n    return $('#js-side-container-' + side)\r\n  }\r\n\r\n  // Mark slots inputs in red if invalid\r\n  $('#slots').on('change', '.js-unit, .js-grp', function () {\r\n    var $this = $(this)\r\n    var val = $this.val().trim()\r\n    if (!val || val.length < SLOTS_INP.MIN || val.length > SLOTS_INP.MAX) {\r\n      $this.addClass('error')\r\n    } else {\r\n      $this.removeClass('error')\r\n    }\r\n  })\r\n\r\n  btnManual.click(function () {\r\n    btnManual.addClass('disabled')\r\n    btnSqm.addClass('disabled')\r\n    slotsContainer.fadeIn()\r\n  })\r\n\r\n  $('#js-slots-btn-reset').click(function () {\r\n    $.each(SLOT_SIDES, function (i, side) {\r\n      removeSide(side)\r\n    })\r\n    slotsContainer.fadeOut()\r\n    btnSqm.removeClass('disabled')\r\n    btnManual.removeClass('disabled')\r\n  })\r\n\r\n  // The selectable 'sides' buttons\r\n  $('.js-btn-side').click(function () {\r\n    var side = $(this).data('side')\r\n    toggleShowSide(side)\r\n    createNewGroup(side)\r\n  })\r\n\r\n  // 'New group' button for each side\r\n  $('.js-btn-newgrp').click(function () {\r\n    var side = $(this).data('side')\r\n    createNewGroup(side)\r\n  })\r\n\r\n  function removeSide (side) {\r\n    var sideContainer = getSideContainer(side)\r\n    $('.js-btn-side[data-side= ' + side + ']').removeClass('toggle active')\r\n    sideContainer.children('.js-group-container').empty()\r\n    return sideContainer.addClass('invis')\r\n  }\r\n\r\n  // Toggles a side after clicking the side buttons\r\n  // or when no groups in side\r\n  function toggleShowSide (side) {\r\n    var sideContainer = getSideContainer(side)\r\n\r\n    if (sideContainer.hasClass('invis')) sideContainer.removeClass('invis')\r\n    else {\r\n      sideContainer.children('.js-group-container').empty()\r\n      sideContainer.addClass('invis')\r\n    }\r\n    $('.js-btn-side[data-side=' + side + ']').toggleClass('toggle active')\r\n  }\r\n\r\n  // Creates a new group and appends to container\r\n  function createNewGroup (side, amountUnits, skipTransition) {\r\n    var sideContainer = getSideContainer(side)\r\n    var grpContainer = GRP_TEMPLATE.clone()\r\n    var unitRoot = grpContainer.children('.segment')\r\n    var l = amountUnits || UNITS_IN_NEW_GRP\r\n    var i = 0\r\n\r\n    for (; i < l; i++) {\r\n      unitRoot.append(UNIT_TEMPLATE.clone())\r\n    }\r\n\r\n    var title = capitalize(side) + ' group'\r\n    unitRoot.prev('h4').html(title)\r\n    addGroupClickHandlers(grpContainer, side)\r\n\r\n    grpContainer.appendTo(sideContainer.find('.js-group-container'))\r\n\r\n    if (!skipTransition) {\r\n      grpContainer.hide().transition('scale')\r\n    }\r\n\r\n    updateUnitsInGroup(grpContainer, l)\r\n    return grpContainer\r\n  }\r\n\r\n  // removes a group with fade out\r\n  function removeGroup (groupEl, side) {\r\n    var rootEl = groupEl.closest('.js-grp-root')\r\n    rootEl.find('.button').addClass('disabled')\r\n    rootEl.transition({\r\n      animation: 'scale',\r\n      allowRepeats: false,\r\n      onComplete: function () {\r\n        rootEl.remove()\r\n        if (!getSideContainer(side).find('.js-grp-root').length) {\r\n          removeSide(side)\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  function updateUnitsInGroup (groupEl, amount) {\r\n    groupEl.find('.js-unit-amount')\r\n      .html('(' + amount + '/' + MAX_UNITS_IN_GRP + ')')\r\n  }\r\n\r\n  // Handlers for rem grp, add or remove unit\r\n  function addGroupClickHandlers (groupEl, side) {\r\n    groupEl.find('.js-btn-description')\r\n    .popup({\r\n      popup: groupEl.find('.popup'),\r\n      transition: 'fade up',\r\n      exclusive: true,\r\n      position: 'bottom left',\r\n      on: 'click'\r\n    })\r\n\r\n    groupEl.find('.js-btn-rmgrp').click(function () {\r\n      removeGroup(groupEl, side)\r\n    })\r\n\r\n    groupEl.find('.js-btn-addunit').click(function () {\r\n      UNIT_TEMPLATE.clone()\r\n      .appendTo(groupEl.find('.js-unit').parent())\r\n      .hide()\r\n      .transition('fade down')\r\n\r\n      var units = groupEl.find('.js-unit').length\r\n      updateUnitsInGroup(groupEl, units)\r\n      if (units >= MAX_UNITS_IN_GRP) {\r\n        $(this).addClass('disabled')\r\n      }\r\n    })\r\n\r\n    groupEl.find('.js-btn-rmunit').click(function (e) {\r\n      var unit = groupEl.find('.js-unit').last()\r\n      if (!unit.length) return\r\n\r\n      unit.transition('fade up', {\r\n        duration: 100,\r\n        onComplete: function () {\r\n          unit.remove()\r\n          var remaining = groupEl.find('.js-unit').length\r\n          updateUnitsInGroup(groupEl, remaining)\r\n          if (!remaining) return removeGroup(groupEl, side)\r\n          if (remaining < MAX_UNITS_IN_GRP) {\r\n            groupEl.find('.js-btn-addunit').removeClass('disabled')\r\n          }\r\n        }\r\n      })\r\n    })\r\n  }\r\n\r\n  var dateInput = (function () {\r\n    var formatDateStr = 'YYYY-MMM-DD, HH:mm'\r\n    var pickDate = $('#create-date').pickadate({\r\n      format: 'ddd dd mmm, yyyy',\r\n      selectYears: false,\r\n      firstDay: true,\r\n      min: window.moment().add(1, 'hour').toDate(),\r\n      max: window.moment().add(2, 'months').toDate()\r\n    })\r\n\r\n    var pickTime = $('#create-time').pickatime({\r\n      format: 'HH:i',\r\n      formatLabel: 'HH:i'\r\n    })\r\n\r\n    pickDate.change(updateTime)\r\n    pickTime.change(updateTime)\r\n\r\n    function updateTime () {\r\n      var d = getUTCDate()\r\n      if (!d) return\r\n      $('#js-time')\r\n        .html('Entered time in UTC: <b>' +\r\n          d.format(formatDateStr) + '</b>')\r\n    }\r\n\r\n    function getUTCDate () {\r\n      var d = pickDate.pickadate('get', 'select')\r\n      var t = pickTime.pickatime('get', 'select')\r\n      if (!d || !t) return null\r\n      d.obj.setHours(t.hour)\r\n      d.obj.setMinutes(t.mins)\r\n      return window.moment(d.obj).utc()\r\n    }\r\n\r\n    return {\r\n      getUTCDate: getUTCDate,\r\n      getDisplayDate: function () {\r\n        var d = getUTCDate()\r\n        if (!d) return null\r\n        return d.format(formatDateStr)\r\n      }\r\n    }\r\n  })()\r\n\r\n  function getEventData () {\r\n    var evt = {\r\n      name: $('.js-event-name').val(),\r\n      type: $('.js-event-type input:checked').val().toLowerCase(),\r\n      authors: $('.js-event-authors').val(),\r\n      description: $('#js-description').val(),\r\n      image_url: $('.js-event-image').val()\r\n    }\r\n\r\n    var d = dateInput.getUTCDate()\r\n    if (d) evt.date = d.toISOString()\r\n\r\n    var grps = evt.groups = []\r\n    $(SLOT_SIDES).each(function (i, side) {\r\n      getSideContainer(side)\r\n      .find('.js-grp-root').each(function () {\r\n        var name = $(this).find('input.js-grp').val()\r\n        var desc = $(this).find('textarea').val()\r\n        var units = []\r\n\r\n        $(this).find('input.js-unit').each(function () {\r\n          units.push({\r\n            description: $(this).val()\r\n          })\r\n        })\r\n\r\n        grps.push({\r\n          name: name,\r\n          side: side,\r\n          description: desc,\r\n          units: units\r\n        })\r\n      })\r\n    })\r\n\r\n    return evt\r\n  }\r\n\r\n  formCreate.find('#js-review-btn').on('click', function updateReview () {\r\n    var missingMsg = 'Not specified'\r\n    function getUnitsAmount (side) {\r\n      return grps\r\n      .filter(function (v) { return v.side === side })\r\n      .map(function (v) { return v.units.length })\r\n      .reduce(function (a, b) { return a + b }, 0)\r\n    }\r\n\r\n    var data = getEventData()\r\n    $('#js-review-list .js-name').html(data.name || missingMsg)\r\n    $('#js-review-list .js-type').html(data.type.toUpperCase())\r\n    $('#js-review-list .js-authors').html(data.authors || missingMsg + ' (default System)')\r\n    $('#js-review-list .js-date').html(dateInput.getDisplayDate() || missingMsg)\r\n\r\n    $('#js-image').attr('src', data.image_url || '')\r\n    .addClass(data.image_url ? '' : 'invis')\r\n    .removeClass(data.image_url ? 'invis' : '')\r\n\r\n    var grps = data.groups || []\r\n    $('#js-review-list .js-groups').html(grps.length)\r\n    if (!grps.length) return $('#js-review-list .js-total').html(0)\r\n\r\n    var str = ''\r\n    SLOT_SIDES.forEach(function (v) {\r\n      var amount = getUnitsAmount(v)\r\n      if (amount) str += capitalize(v) + ': ' + amount + ', '\r\n    })\r\n    $('#js-review-list .js-total').html(str.substr(0, str.lastIndexOf(',')))\r\n  })\r\n\r\n  function submitEvent () {\r\n    var evt = getEventData()\r\n\r\n    btnSubmit.addClass('disabled loading')\r\n    $.ajax({\r\n      url: '/events/create',\r\n      type: 'POST',\r\n      contentType: 'application/json',\r\n      data: JSON.stringify(evt)\r\n    })\r\n    .success(function (response) {\r\n      if (!response.ok) {\r\n        var cntr = $('#js-create-errors').html('').append('<ul class=\"list\">')\r\n        if ($.isArray(response.error)) {\r\n          $.each(response.error, function (i, err) {\r\n            cntr.append($('<li>' + err + '</li>'))\r\n          })\r\n        } else {\r\n          cntr.append($('<li>' + response.error + '</li>'))\r\n        }\r\n        cntr.append('</ul>').fadeIn()\r\n        btnSubmit.removeClass('loading disabled')\r\n      }else {\r\n        window.location.replace(window.location.origin + '/events/event/' + response.data)\r\n      }\r\n    })\r\n  }\r\n\r\n  var sqmErrorContainer = $('#js-sqm-error')\r\n  var printSqmError = function (msg) {\r\n    if (!msg) return\r\n    sqmErrorContainer.find('p').html(msg)\r\n    sqmErrorContainer.fadeIn()\r\n  }\r\n\r\n  /* Handle Upload SQM*/\r\n  var xhr2 = !!(window.FormData && ('upload' in ($.ajaxSettings.xhr())))\r\n  if (!xhr2) {\r\n    $('#js-slots-btn-sqm').addClass('disabled')\r\n    printSqmError('Your browser does not support file upload')\r\n  } else {\r\n    var fileForm = $('#js-form-upload-file')\r\n    var sqmFileInput = $('#js-input-file-sqm')\r\n    var sqmUploadBtn = $('#js-slots-btn-sqm')\r\n\r\n    // Resets the input\r\n    var resetFileInput = function () {\r\n      sqmFileInput.wrap('<form>').closest('form').get(0).reset()\r\n      sqmFileInput.unwrap()\r\n    }\r\n\r\n    sqmUploadBtn.click(function (e) {\r\n      e.preventDefault()\r\n      sqmErrorContainer.fadeOut()\r\n      sqmFileInput.click()\r\n    })\r\n\r\n    sqmFileInput.change(function () {\r\n      var file = this.files[0]\r\n      if (!file || !file.size) return\r\n      if (file.size > (1024 * 1024 * 3)) {\r\n        resetFileInput()\r\n        return printSqmError('File exceeds limit (3mb)')\r\n      }\r\n      sqmUploadBtn.addClass('loading disabled')\r\n      fileForm.submit()\r\n    })\r\n\r\n    var handleParsedSqmGroups = function (reply) {\r\n      btnSqm.removeClass('disabled')\r\n      if (!reply.ok) return printSqmError(reply.error)\r\n      if (!reply.data.length) return printSqmError('No groups found')\r\n      btnManual.addClass('disabled')\r\n      btnSqm.addClass('disabled')\r\n\r\n      var sides = []\r\n      $.each(reply.data, function (i, grp) {\r\n        if (!~sides.indexOf(grp.side)) sides.push(grp.side)\r\n        var grpCntr = createNewGroup(grp.side, grp.units.length, true)\r\n        var grpInp = grpCntr.find('.js-grp')\r\n        grpInp.val(grp.name)\r\n        if (grp.name.length < SLOTS_INP.MIN || grp.name.length > SLOTS_INP.MAX) {\r\n          grpInp.addClass('error')\r\n        }\r\n\r\n        var units = grpCntr.find('.js-unit')\r\n        $.each(grp.units, function (i, unit) {\r\n          var inp = $(units.get(0))\r\n          inp.val(unit.description)\r\n          if (unit.description.length < SLOTS_INP.MIN ||\r\n              unit.description.length > SLOTS_INP.MAX) {\r\n            inp.addClass('error')\r\n          }\r\n          units.splice(0, 1)\r\n        })\r\n      })\r\n\r\n      $.each(sides, function (i, side) {\r\n        toggleShowSide(side)\r\n      })\r\n      slotsContainer.fadeIn()\r\n    }\r\n\r\n    // Submits SQM file\r\n    fileForm.submit(function (e) {\r\n      e.preventDefault()\r\n      var formData = new window.FormData($(this)[0])\r\n\r\n      $.ajax({\r\n        url: '/events/create/upload-sqm',\r\n        type: 'POST',\r\n        data: formData,\r\n        cache: false,\r\n        contentType: false,\r\n        processData: false\r\n      })\r\n      .success(handleParsedSqmGroups)\r\n      .always(function () {\r\n        resetFileInput()\r\n        sqmUploadBtn.removeClass('loading')\r\n      })\r\n      return false\r\n    })\r\n  }\r\n})(window.jQuery)\r\n"]}